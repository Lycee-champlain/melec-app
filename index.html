<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devis MELEC - RS Components</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
    .header { background: linear-gradient(90deg, #1a5fb4, #007acc); color: white; padding: 20px; text-align: center; }
    .header img { max-height: 60px; margin-bottom: 10px; border-radius: 4px; }
    .header h1 { font-size: 1.8em; margin-bottom: 5px; }
    .section { padding: 20px; border-bottom: 1px solid #eee; }
    .section:last-child { border-bottom: none; }
    .section h2 { color: #1a5fb4; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em; margin: 5px; }
    .btn:hover { background: #218838; }
    .btn-secondary { background: #6c757d; }
    .btn-danger { background: #dc3545; }
    .btn-warning { background: #ffc107; color: #212529; }
    input, textarea, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; max-width: 400px; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; }
    .total { font-size: 1.2em; font-weight: bold; background: #e8f5e8; padding: 15px; border-radius: 6px; }
    .import-zone { background: #d4edda; border-left: 4px solid #28a745; }
    #status { color: #28a745; font-weight: bold; }
    @media print { body { background: white; padding: 0; } .no-print { display: none !important; } }
    @media (max-width: 768px) { .container { margin: 0; border-radius: 0; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER SOCI√âT√â -->
    <div class="header" id="headerSoc">
      <img id="logoSoc" src="" alt="Logo" style="display: none;">
      <h1 id="nomSoc">√âLEC INSTALL SARL</h1>
      <p id="adresseSoc">Chargement...</p>
    </div>

    <!-- PROJET & CLIENT -->
    <div class="section">
      <h2>üìã Projet & Client</h2>
      <input type="text" id="projet" placeholder="ex: Installation √©lectrique T2" value="Installation √©lectrique studio T2">
      <input type="text" id="client" placeholder="ex: M. Martin" value="M. Martin">
    </div>

    <!-- IMPORT RS CSV -->
    <div class="section import-zone">
      <h2>üì• Importer liste Radiospares</h2>
      <p>Glisse ton CSV RS ici ‚Üí Schneider Wiser OK !</p>
      <input type="file" id="fileCSV" accept=".csv">
      <div style="margin: 10px 0;">
        <button class="btn" onclick="importerCSV()">üöÄ Importer</button>
        <button class="btn btn-danger" onclick="viderPanier()">üóëÔ∏è Vider panier</button>
        <button class="btn btn-warning" onclick="reinitialiserApp()">üîÑ R√©init tout</button>
      </div>
      <div id="status"></div>
    </div>

    <!-- MAIN D'OEUVRE -->
    <div class="section">
      <h2>üë∑ Main d'≈ìuvre</h2>
      <label>Heures: <input type="number" id="heuresPose" step="0.25" value="4.0" min="0"></label>
      <label>Taux HT (‚Ç¨/h): <input type="number" id="tauxHoraire" step="0.01" value="45.00" min="0"></label>
    </div>

    <!-- CONFIG SOCI√âT√â -->
    <div class="section">
      <h2>üè¢ Soci√©t√©</h2>
      <input type="text" id="newNom" placeholder="Nom soci√©t√©">
      <textarea id="newAdresse" rows="3" placeholder="Adresse&#10;12 rue des Circuits&#10;94000 Cr√©teil"></textarea>
      <label>Logo: <input type="file" id="newLogo" accept="image/*"></label>
      <button class="btn" onclick="sauvegarderConfig()">üíæ Sauvegarder</button>
    </div>

    <!-- PANIER -->
    <div class="section">
      <h2>üõí Panier (<span id="comptePanier">0</span> articles)</h2>
      <table id="tableauPanier">
        <thead><tr><th>R√©f</th><th>Description</th><th>Marque</th><th>Qt√©</th><th>PU HT</th><th>Total</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TOTAUX -->
    <div class="section total" id="totaux">
      Mat√©riel: 0‚Ç¨ | MO: 0‚Ç¨ | HT: 0‚Ç¨ | TVA: 0‚Ç¨ | TTC: 0‚Ç¨
    </div>

    <!-- ACTIONS -->
    <div class="section">
      <button class="btn" onclick="exporterCSV()">üíæ Export CSV</button>
      <button class="btn no-print" onclick="imprimerFacture()">üñ®Ô∏è Facture</button>
    </div>
  </div>

  <script>
    // GLOBALS
    let panier = JSON.parse(localStorage.getItem('panierMELEC')) || [];
    let config = JSON.parse(localStorage.getItem('configEntreprise')) || {
      nom: '√âLEC INSTALL SARL', adresse: '12 rue des Circuits\n94000 Cr√©teil', tauxHoraire: 45, logo: ''
    };

    // PARSER CSV ADAPT√â TON FICHIER RS (split espace fixe)
    function parserCSV(csvText) {
      const status = document.getElementById('status');
      if (!csvText) { status.textContent = 'Erreur: CSV vide'; return []; }
      status.textContent = 'Parsing...';
      
      // Split lignes + nettoyage
      const lignes = csvText.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('---'));
      const items = [];
      
      lignes.slice(1).forEach((ligne, idx) => { // Skip header
        try {
          // Split par espaces multiples (format RS compact)
          const cols = ligne.split(/\s{2,}/); // 2+ espaces
          if (cols.length < 9) return;
          
          const refRS = cols[0].trim();
          const desc = cols[5].trim();
          const marque = cols[7].trim();
          let prixStr = cols[8] ? cols[8].replace(/[‚Ç¨\s]/g, '').replace(',', '.') : '0';
          const puHT = parseFloat(prixStr) || 0;
          
          if (refRS && puHT > 0 && !items.some(i => i.ref === refRS)) {
            items.push({ ref: refRS, desc, marque, qte: 1, puHT });
          }
        } catch(e) { console.warn('Ligne', idx, ':', ligne); }
      });
      
      status.textContent = `${items.length} articles import√©s !`;
      return items;
    }

    // IMPORT (bouton + listener)
    function importerCSV() {
      const file = document.getElementById('fileCSV').files[0];
      if (!file) return document.getElementById('status').textContent = 'Choisis CSV !';
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const nouveaux = parserCSV(e.target.result);
        panier.push(...nouveaux);
        localStorage.setItem('panierMELEC', JSON.stringify(panier));
        mettreAJourTableau();
        document.getElementById('fileCSV').value = '';
      };
      reader.readAsText(file);
    }
    document.getElementById('fileCSV').addEventListener('change', importerCSV);

    // TABLEAU
    function mettreAJourTableau() {
      document.getElementById('comptePanier').textContent = panier.length;
      const tbody = document.querySelector('#tableauPanier tbody');
      tbody.innerHTML = '';
      panier.forEach((item, i) => {
        const totalLigne = item.qte * item.puHT;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.ref}</td>
          <td>${item.desc}</td>
          <td>${item.marque}</td>
          <td><input type="number" value="${item.qte}" min="1" step="1" onchange="panier[${i}].qte = +this.value || 1; sauvegarderPanier(); mettreAJourTableau(); mettreAJourTotaux();" style="width: 60px;"></td>
          <td>${item.puHT.toFixed(2)}</td>
          <td>${totalLigne.toFixed(2)}</td>
          <td><button class="btn btn-danger" onclick="supprimerItem(${i})" style="padding: 5px 10px; font-size: 0.9em;">‚úï</button></td>
        `;
        tbody.appendChild(tr);
      });
      mettreAJourTotaux();
    }

    // HELPERS
    function sauvegarderPanier() { localStorage.setItem('panierMELEC', JSON.stringify(panier)); }
    function supprimerItem(i) { panier.splice(i, 1); sauvegarderPanier(); mettreAJourTableau(); }

    // VIDANGE / R√âINIT ‚úÖ FIX√âES
    function viderPanier() {
      if (confirm('Vider panier (' + panier.length + ' articles) ?')) {
        panier = [];
        localStorage.removeItem('panierMELEC');
        document.getElementById('status').textContent = 'Panier vid√© !';
        mettreAJourTableau();
      }
    }
    function reinitialiserApp() {
      if (confirm('R√©initialiser TOUT (panier + config) ?')) {
        localStorage.clear();
        location.reload();
      }
    }

    // TOTAUX
    function mettreAJourTotaux() {
      const materiel = panier.reduce((s, i) => s + i.qte * i.puHT, 0);
      const heures = +document.getElementById('heuresPose').value || 0;
      const taux = +document.getElementById('tauxHoraire').value || 0;
      const mo = heures * taux;
      const ht = materiel + mo;
      const tva = ht * 0.2;
      const ttc = ht + tva;
      document.getElementById('totaux').innerHTML = 
        `Mat√©riel: ${materiel.toFixed(2)}‚Ç¨ | MO: ${mo.toFixed(2)}‚Ç¨ | <strong>HT: ${ht.toFixed(2)}‚Ç¨</strong> | TVA: ${tva.toFixed(2)}‚Ç¨ | <strong>TTC: ${ttc.toFixed(2)}‚Ç¨</strong>`;
    }

    // SOCI√âT√â
    function majHeader() {
      document.getElementById('nomSoc').textContent = config.nom;
      document.getElementById('adresseSoc').textContent = config.adresse;
      const img = document.getElementById('logoSoc');
      img.src = config.logo || '';
      img.style.display = config.logo ? 'block' : 'none';
    }
    function sauvegarderConfig() {
      config.nom = document.getElementById('newNom').value || config.nom;
      config.adresse = document.getElementById('newAdresse').value || config.adresse;
      config.tauxHoraire = +document.getElementById('tauxHoraire').value || 45;
      const file = document.getElementById('newLogo').files[0];
      if (file) {
        const r = new FileReader();
        r.onload = e => { config.logo = e.target.result; localStorage.setItem('configEntreprise', JSON.stringify(config)); majHeader(); };
        r.readAsDataURL(file);
      } else {
        localStorage.setItem('configEntreprise', JSON.stringify(config));
        majHeader();
      }
    }

    // EXPORT / PRINT
    function exporterCSV() {
      const csv = ['Ref,Description,Marque,Qte,PU_HT,Total', ...panier.map(i => `${i.ref},"${i.desc}",${i.marque},${i.qte},${i.puHT},${i.qte*i.puHT}`)].join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'devis_melec.csv'; a.click();
    }
    function imprimerFacture() { window.print(); }

    // √âVENTS
    document.getElementById('heuresPose').addEventListener('input', mettreAJourTotaux);
    document.getElementById('tauxHoraire').addEventListener('input', mettreAJourTotaux);

    // INIT
    document.getElementById('newNom').value = config.nom;
    document.getElementById('newAdresse').value = config.adresse;
    document.getElementById('tauxHoraire').value = config.tauxHoraire;
    majHeader();
    mettreAJourTableau();
  </script>
</body>
</html>
