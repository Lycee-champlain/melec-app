<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MELEC PRO | Suivi Collaboratif</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #fff; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* LOGIN SCREEN */
        #loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; }
        .login-box { background: white; padding: 40px; border-radius: 12px; color: var(--text); width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box h1 { margin-top: 0; color: var(--primary); }
        select, input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 6px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-main:hover { background: #1d4ed8; }

        /* APP LAYOUT */
        #appScreen { display: none; height: 100%; }
        aside { width: 250px; background: #0f172a; color: white; padding: 20px; display: flex; flex-direction: column; }
        main { flex: 1; padding: 20px; overflow-y: auto; }
        
        .nav-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 6px; color: #94a3b8; }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }
        
        /* CARDS */
        .card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        /* PROJETS PROF */
        .proj-card { border-left: 5px solid var(--primary); cursor: pointer; transition: 0.2s; }
        .proj-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* TIMELINE ELEVE */
        .timeline-item { border-left: 2px solid #e2e8f0; padding-left: 20px; margin-left: 10px; padding-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; position: absolute; left: -7px; top: 0; }
        
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; background: #e0f2fe; color: #0369a1; font-weight: bold; }
    </style>
</head>
<body>

    <!-- ECRAN DE CONNEXION (Point d'entr√©e MonLyc√©e.net) -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>‚ö° MELEC PRO</h1>
            <p>Acc√®s via MonLyc√©e.net</p>
            
            <div id="eleveLogin">
                <select id="loginClasse">
                    <option value="">-- Choisir ma Classe --</option>
                    <option value="T_MELEC_A">Terminale MELEC A</option>
                    <option value="T_MELEC_B">Terminale MELEC B</option>
                    <option value="1_MELEC">Premi√®re MELEC</option>
                </select>
                <input type="text" id="loginGroupe" placeholder="Nom de mon Groupe (ex: Stade)">
                <button class="btn-main" onclick="app.loginEleve()">Entrer (√âl√®ve)</button>
                <p style="margin-top:20px; font-size:0.8rem; color:#64748b; cursor:pointer; text-decoration:underline;" onclick="ui.showProfLogin()">Acc√®s Enseignant</p>
            </div>

            <div id="profLogin" class="hidden">
                <input type="password" id="profPass" placeholder="Code Enseignant">
                <button class="btn-main" style="background:#0f172a;" onclick="app.loginProf()">Connexion Prof</button>
                <p style="margin-top:20px; font-size:0.8rem; color:#64748b; cursor:pointer;" onclick="ui.showEleveLogin()">Retour √âl√®ve</p>
            </div>
        </div>
    </div>

    <!-- ECRAN APPLICATION -->
    <div id="appScreen">
        <aside>
            <div style="font-weight:bold; font-size:1.2rem; margin-bottom:30px;">‚ö° MELEC PRO</div>
            <div id="userInfo" style="font-size:0.8rem; color:#94a3b8; margin-bottom:20px; border-bottom:1px solid #334155; padding-bottom:10px;"></div>
            
            <!-- Menu √âl√®ve -->
            <div id="menuEleve" class="hidden">
                <div class="nav-item active" onclick="ui.nav('dashboard')">üè† Mon Projet</div>
                <div class="nav-item" onclick="ui.nav('journal')">üìù Journal de Chantier</div>
                <div class="nav-item" onclick="ui.nav('doc')">üìÑ Documents BAC</div>
            </div>

            <!-- Menu Prof -->
            <div id="menuProf" class="hidden">
                <div class="nav-item active" onclick="ui.nav('profDash')">üéì Supervision Globale</div>
                <div class="nav-item" onclick="ui.nav('profArchive')">üóÑÔ∏è Archives Ann√©es</div>
            </div>
            
            <div style="flex:1;"></div>
            <div class="nav-item" onclick="location.reload()" style="color:#ef4444;">üö™ D√©connexion</div>
        </aside>

        <main>
            <!-- VUE ELEVE : DASHBOARD -->
            <div id="view-dashboard" class="hidden">
                <div class="card">
                    <h2>üìç Avancement du Projet <span id="projTitleDisplay" class="badge"></span></h2>
                    <textarea id="projDesc" style="width:100%; height:100px; padding:10px; border:1px solid #e2e8f0; border-radius:6px;" placeholder="Description technique du projet..." onblur="app.saveProjet()"></textarea>
                    <div style="margin-top:10px; text-align:right;">
                        <span id="saveStatus" style="color:#10b981; font-size:0.8rem;"></span>
                    </div>
                </div>
            </div>

            <!-- VUE ELEVE : JOURNAL (Pr√©pa Oral) -->
            <div id="view-journal" class="hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <h2>üìù Journal de Chantier</h2>
                        <button class="btn-main" style="width:auto;" onclick="app.addJournalEntry()">+ Nouvelle Entr√©e</button>
                    </div>
                    <div id="journalList" style="margin-top:20px;"></div>
                </div>
            </div>

            <!-- VUE PROF : SUPERVISION -->
            <div id="view-profDash" class="hidden">
                <h2>üéì Tableau de Bord Enseignant</h2>
                <div class="card">
                    <select id="filterClasse" onchange="app.loadAllProjects()" style="width:200px;">
                        <option value="all">Toutes les classes</option>
                        <option value="T_MELEC_A">T_MELEC_A</option>
                        <option value="T_MELEC_B">T_MELEC_B</option>
                    </select>
                </div>
                <div id="profProjectGrid" class="grid"></div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURATION FIREBASE (REMPLACER ICI !) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCtsJQl2jwVds3Txa-nZ9xBdyyY8MCJ3cs",
            authDomain: "melec-suivi-projets.firebaseapp.com",
            projectId: "melec-suivi-projets",
            storageBucket: "melec-suivi-projets.firebasestorage.app",
            messagingSenderId: "140759755218",
            appId: "1:140759755218:web:184fc7e3087a8e6ae3800b"
        };
        // Initialisation
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. LOGIQUE APP ---
        const PROF_CODE = "1234"; // Code prof simple
        let currentUser = { role: null, classe: null, groupe: null, id: null };

        const app = {
            loginEleve: async () => {
                const classe = document.getElementById('loginClasse').value;
                const groupe = document.getElementById('loginGroupe').value.trim();
                if(!classe || !groupe) return alert("Veuillez tout remplir");

                // ID unique du projet (ex: 2026_T_MELEC_A_Stade)
                const annee = "2025-2026"; 
                const projId = `${annee}_${classe}_${groupe}`.replace(/[^a-z0-9_]/gi, '');

                currentUser = { role: 'eleve', classe, groupe, id: projId, annee };
                
                // V√©rifier si projet existe, sinon cr√©er
                const docRef = db.collection('Projets').doc(projId);
                const doc = await docRef.get();
                if(!doc.exists) {
                    await docRef.set({
                        titre: groupe,
                        classe: classe,
                        annee: annee,
                        description: "",
                        created: new Date(),
                        journal: []
                    });
                }
                
                ui.initApp('eleve');
                app.loadProjet();
            },

            loginProf: () => {
                const pass = document.getElementById('profPass').value;
                if(pass === PROF_CODE) {
                    currentUser = { role: 'prof' };
                    ui.initApp('prof');
                    app.loadAllProjects();
                } else {
                    alert("Code incorrect");
                }
            },

            // --- √âL√àVE : Charger son projet ---
            loadProjet: async () => {
                const doc = await db.collection('Projets').doc(currentUser.id).get();
                const data = doc.data();
                document.getElementById('projTitleDisplay').innerText = data.titre;
                document.getElementById('projDesc').value = data.description || "";
                app.renderJournal(data.journal || []);
            },

            saveProjet: async () => {
                const desc = document.getElementById('projDesc').value;
                await db.collection('Projets').doc(currentUser.id).update({ description: desc });
                document.getElementById('saveStatus').innerText = "Sauvegard√© !";
                setTimeout(() => document.getElementById('saveStatus').innerText = "", 2000);
            },

            addJournalEntry: async () => {
                const txt = prompt("Activit√© du jour :");
                if(!txt) return;
                const entry = { date: new Date().toISOString(), text: txt };
                
                // Ajout Firebase (arrayUnion)
                await db.collection('Projets').doc(currentUser.id).update({
                    journal: firebase.firestore.FieldValue.arrayUnion(entry)
                });
                app.loadProjet(); // Recharger
            },

            renderJournal: (entries) => {
                const div = document.getElementById('journalList');
                div.innerHTML = entries.reverse().map(e => `
                    <div class="timeline-item">
                        <small style="color:#64748b">${new Date(e.date).toLocaleDateString()}</small>
                        <div>${e.text}</div>
                    </div>
                `).join('');
            },

            // --- PROF : Charger TOUS les projets ---
            loadAllProjects: async () => {
                const filter = document.getElementById('filterClasse').value;
                let query = db.collection('Projets').where('annee', '==', '2025-2026');
                if(filter !== 'all') query = query.where('classe', '==', filter);

                const snapshot = await query.get();
                const grid = document.getElementById('profProjectGrid');
                grid.innerHTML = snapshot.docs.map(doc => {
                    const d = doc.data();
                    return `
                        <div class="card proj-card" onclick="alert('D√©tails de ${d.titre} √† impl√©menter !')">
                            <h3>${d.titre}</h3>
                            <span class="badge">${d.classe}</span>
                            <p style="font-size:0.8rem; color:#64748b; margin-top:10px;">${d.description.substring(0,50)}...</p>
                        </div>
                    `;
                }).join('');
            }
        };

        const ui = {
            showProfLogin: () => { document.getElementById('eleveLogin').classList.add('hidden'); document.getElementById('profLogin').classList.remove('hidden'); },
            showEleveLogin: () => { document.getElementById('profLogin').classList.add('hidden'); document.getElementById('eleveLogin').classList.remove('hidden'); },
            
            initApp: (role) => {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'flex';
                
                if(role === 'eleve') {
                    document.getElementById('menuEleve').classList.remove('hidden');
                    document.getElementById('userInfo').innerText = `√âl√®ve | ${currentUser.classe} | ${currentUser.groupe}`;
                    ui.nav('dashboard');
                } else {
                    document.getElementById('menuProf').classList.remove('hidden');
                    document.getElementById('userInfo').innerText = `Enseignant | Supervision`;
                    ui.nav('profDash');
                }
            },

            nav: (view) => {
                document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-'+view).classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
