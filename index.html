<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devis MELEC - RS Components</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
    .header { background: linear-gradient(90deg, #1a5fb4, #007acc); color: white; padding: 20px; text-align: center; }
    .header img { max-height: 60px; margin-bottom: 10px; }
    .header h1 { font-size: 1.8em; margin-bottom: 5px; }
    .section { padding: 20px; border-bottom: 1px solid #eee; }
    .section:last-child { border-bottom: none; }
    .section h2 { color: #1a5fb4; margin-bottom: 15px; font-size: 1.3em; }
    select, input, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; margin-bottom: 10px; }
    .btn { background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .btn:hover { background: #218838; }
    .btn-danger { background: #dc3545; }
    .btn-danger:hover { background: #c82333; }
    .btn-secondary { background: #6c757d; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f8f9fa; font-weight: bold; }
    .total { font-size: 1.4em; font-weight: bold; color: #1a5fb4; text-align: right; margin-top: 15px; }
    .prof-tools { background: #fff3cd; border-left: 4px solid #ffc107; }
    .import-zone { background: #d4edda; border-left: 4px solid #28a745; }
    @media (max-width: 768px) { .container { margin: 10px; border-radius: 8px; } }
  </style>
</head>
<body>

<div class="container">

  <!-- EN-T√äTE SOCI√âT√â -->
  <div class="header" id="header">
    <img id="logo" src="https://via.placeholder.com/200x60/1a5fb4/ffffff?text=LOGO" alt="Logo">
    <h1 id="entrepriseNom">√âLEC INSTALL SARL</h1>
    <p id="entrepriseInfo">12 rue des Circuits<br>94000 Cr√©teil<br>SIRET : 123 456 789 00012 | T√©l : 01 23 45 67 89</p>
  </div>

  <!-- PROJET & CLIENT -->
  <div class="section">
    <h2>üìã Projet & Client</h2>
    <input type="text" id="projet" placeholder="Nom du projet (ex : Installation studio T2)" value="Installation studio T2">
    <input type="text" id="client" placeholder="Nom client (ex : M. Martin)" value="M. Martin">
  </div>

  <!-- IMPORT RS (NOUVEAU) -->
  <div class="section import-zone">
    <h2>üì• Importer liste Radiospares</h2>
    <p><em>1. Cr√©e liste sur <a href="https://fr.rs-online.com" target="_blank">RS</a> ‚Üí 2. Export CSV ‚Üí 3. Glisse ici</em></p>
    <input type="file" id="importCSV" accept=".csv" style="width: 100%; padding: 10px;">
    <div id="importPreview"></div>
    <button class="btn" onclick="importerListeRS()" style="margin-top: 10px;">üöÄ Importer devis</button>
  </div>

  <!-- AJOUT MANUEL -->
  <div class="section">
    <h2>‚ûï Ou ajouter manuellement</h2>
    <select id="ref">
      <option value="">Choisir mat√©riel...</option>
      <option value="schneider-acti9" data-prix="8.50" data-marque="Schneider">Acti9 iC60N 16A C (8.50‚Ç¨)</option>
      <option value="legrand-dx3" data-prix="9.20" data-marque="Legrand">DX¬≥ 16A C (9.20‚Ç¨)</option>
    </select>
    <input type="number" id="qteManuel" value="1" min="1" style="width: 100px; display: inline-block;">
    <button class="btn" onclick="ajouterManuel()" style="display: inline-block;">‚ûï Ajouter</button>
  </div>

  <!-- HEURES & MO -->
  <div class="section">
    <h2>‚è±Ô∏è Main d'≈ìuvre</h2>
    <label>Heures estim√©es : <input type="number" id="heuresPose" value="4" min="0" step="0.5" style="width: 100px;"></label>
    <div>Main d'≈ìuvre : <strong id="coutMainOeuvre">180,00</strong> ‚Ç¨ HT</div>
  </div>

  <!-- DEVIS FINAL -->
  <div class="section">
    <h2>üí∞ Devis complet</h2>
    <table id="tableau">
      <thead><tr><th>Article</th><th>Marque</th><th>Qt√©</th><th>Prix HT</th><th>Total</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="total">
      Mat√©riel HT : <span id="sousTotalMat">0,00</span> ‚Ç¨<br>
      Main d'≈ìuvre : <span id="sousTotalMO">0,00</span> ‚Ç¨<br>
      <strong>SOUS-TOTAL HT : <span id="sousTotal">0,00</span> ‚Ç¨</strong><br>
      TVA 20% : <span id="tva">0,00</span> ‚Ç¨<br>
      <strong>TOTAL TTC : <span id="totalTTC">0,00</span> ‚Ç¨</strong>
    </div>
    <button class="btn" onclick="imprimerFacture()">üñ®Ô∏è Facture PDF</button>
    <button class="btn btn-secondary" onclick="viderPanier()">üóëÔ∏è Vider panier</button>
  </div>

  <!-- CONFIG SOCI√âT√â -->
  <div class="section prof-tools">
    <h2>üè¢ Soci√©t√© & Tarifs</h2>
    <input type="text" id="newEntreprise" placeholder="Nom soci√©t√©">
    <textarea id="newAdresse" rows="3" placeholder="Adresse&#10;Rue, Code postal, Ville"></textarea>
    <input type="url" id="newLogo" placeholder="URL logo">
    <label>Taux horaire HT (‚Ç¨) : <input type="number" id="tauxHoraire" step="0.01" value="45"></label>
    <button class="btn" onclick="sauvegarderConfig()">üíæ Sauvegarder</button>
  </div>

</div>

<script>
let panier = JSON.parse(localStorage.getItem('panierMELEC')) || [];
let config = JSON.parse(localStorage.getItem('configEntreprise')) || {
  nom: '√âLEC INSTALL SARL',
  adresse: '12 rue des Circuits\n94000 Cr√©teil\nSIRET : 12345678900012',
  logo: 'https://via.placeholder.com/200x60/1a5fb4/ffffff?text=LOGO',
  tauxHoraire: 45.00
};
let listeImportee = [];

// Initialisation
document.getElementById('entrepriseNom').textContent = config.nom;
document.getElementById('logo').src = config.logo;
document.getElementById('entrepriseInfo').textContent = config.adresse;
document.getElementById('newEntreprise').value = config.nom;
document.getElementById('newAdresse').value = config.adresse;
document.getElementById('newLogo').value = config.logo;
document.getElementById('tauxHoraire').value = config.tauxHoraire;

document.getElementById('heuresPose').addEventListener('input', mettreAJourTableau);
mettreAJourTableau();

// IMPORT CSV RS
document.getElementById('importCSV').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    parserCSV(e.target.result);
  };
  reader.readAsText(file, 'ISO-8859-1');
});

function parserCSV(csv) {
  const lignes = csv.split('\n').map(l => l.split(/;(?! )/)); // S√©parateur intelligent
  listeImportee = [];
  const preview = document.getElementById('importPreview');
  preview.innerHTML = `<h4>‚úÖ ${lignes.length-1} articles RS :</h4>`;

  lignes.slice(1).forEach((ligne, i) => {
    if (ligne.length < 3) return;
    const ref = ligne[0]?.trim() || '';
    const libelle = ligne[1]?.trim() || 'Article';
    const prixStr = ligne[2]?.replace(/[‚Ç¨\s,]/g, '').replace('.', ',');
    const prix = parseFloat(prixStr.replace(',', '.')) || 0;

    if (ref && prix > 0) {
      listeImportee.push({ ref, marque: 'RS', libelle, prix, qte: 1 });
      preview.innerHTML += `<div style="padding:8px;border-bottom:1px solid #ddd;">${ref} - ${libelle} ‚Üí ${prix.toFixed(2)}‚Ç¨</div>`;
    }
  });
}

function importerListeRS() {
  if (!listeImportee.length) return alert('Importe CSV d\'abord !');
  panier.push(...listeImportee);
  alert(`‚úÖ ${listeImportee.length} articles import√©s !`);
  document.getElementById('importPreview').innerHTML = '';
  document.getElementById('importCSV').value = '';
  listeImportee = [];
  mettreAJourTableau();
}

function ajouterManuel() {
  const select = document.getElementById('ref');
  const option = select.options[select.selectedIndex];
  if (!option.dataset.prix) return alert('Choisis un article !');
  
  panier.push({
    ref: option.value,
    marque: option.dataset.marque,
    libelle: option.textContent.replace(/ *\([^)]*\)/, ''),
    prix: parseFloat(option.dataset.prix),
    qte: parseInt(document.getElementById('qteManuel').value) || 1
  });
  document.getElementById('qteManuel').value = 1;
  mettreAJourTableau();
}

function mettreAJourTableau() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  
  let totalMat = 0;
  panier.forEach((ligne, i) => {
    const totalLigne = ligne.prix * ligne.qte;
    totalMat += totalLigne;
    tbody.innerHTML += `
      <tr>
        <td>${ligne.libelle}</td>
        <td>${ligne.marque}</td>
        <td>${ligne.qte}</td>
        <td>${ligne.prix.toFixed(2)}‚Ç¨</td>
        <td>${totalLigne.toFixed(2)}‚Ç¨</td>
      </tr>`;
  });

  const heures = parseFloat(document.getElementById('heuresPose').value) || 0;
  const totalMO = heures * config.tauxHoraire;
  const sousTotal = totalMat + totalMO;
  const tva = sousTotal * 0.20;
  const totalTTC = sousTotal + tva;

  document.getElementById('sousTotalMat').textContent = totalMat.toFixed(2);
  document.getElementById('sousTotalMO').textContent = totalMO.toFixed(2);
  document.getElementById('sousTotal').textContent = sousTotal.toFixed(2);
  document.getElementById('tva').textContent = tva.toFixed(2);
  document.getElementById('totalTTC').textContent = totalTTC.toFixed(2);
  document.getElementById('coutMainOeuvre').textContent = totalMO.toFixed(2);

  localStorage.setItem('panierMELEC', JSON.stringify(panier));
}

function sauvegarderConfig() {
  config.nom = document.getElementById('newEntreprise').value;
  config.adresse = document.getElementById('newAdresse').value;
  config.logo = document.getElementById('newLogo').value;
  config.tauxHoraire = parseFloat(document.getElementById('tauxHoraire').value) || 45;
  
  document.getElementById('entrepriseNom').textContent = config.nom;
  document.getElementById('logo').src = config.logo;
  document.getElementById('entrepriseInfo').textContent = config.adresse;
  
  localStorage.setItem('configEntreprise', JSON.stringify(config));
  alert('‚úÖ Soci√©t√© mise √† jour !');
  mettreAJourTableau();
}

function imprimerFacture() {
  if (!panier.length) return alert('Panier vide !');
  const projet = document.getElementById('projet').value || 'Non sp√©cifi√©';
  const client = document.getElementById('client').value || 'Non sp√©cifi√©';
  
  const win = window.open('', '_blank');
  win.document.write(`
    <html><head><title>Facture ${projet}</title>
    <style>body{font-family:Arial;margin:40px;}table{width:100%;border-collapse:collapse;}
    th{background:#1a5fb4;color:white;padding:12px;}td{padding:8px;border-bottom:1px solid #ddd;}
    .total{font-size:20px;font-weight:bold;text-align:right;margin:20px 0;}</style></head>
    <body>
      <div style="text-align:center;margin-bottom:40px;">
        <img src="${config.logo}" style="max-height:60px;"><br>
        <h1 style="color:#1a5fb4;">${config.nom}</h1>
        <div>${config.adresse.replace(/\n/g,'<br>')}</div>
      </div>
      <div style="background:#f8f9fa;padding:20px;margin-bottom:20px;">
        <h2>üìã PROJET</h2>
        <p><strong>Projet :</strong> ${projet}</p>
        <p><strong>Client :</strong> ${client}</p>
        <p><strong>Date :</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
      </div>
      <table>
        <tr><th>Article</th><th>Marque</th><th>Qt√©</th><th>Prix HT</th><th>Total</th></tr>
        ${panier.map(l=>`<tr><td>${l.libelle}</td><td>${l.marque}</td><td>${l.qte}</td><td>${l.prix.toFixed(2)}‚Ç¨</td><td>${(l.prix*l.qte).toFixed(2)}‚Ç¨</td></tr>`).join('')}
      </table>
      <div class="total">
        Mat√©riel : ${document.getElementById('sousTotalMat').textContent}‚Ç¨<br>
        Main d'≈ìuvre : ${document.getElementById('sousTotalMO').textContent}‚Ç¨<br>
        <hr style="border:2px solid #1a5fb4;">
        SOUS-TOTAL HT : ${document.getElementById('sousTotal').textContent}‚Ç¨<br>
        TVA 20% : ${document.getElementById('tva').textContent}‚Ç¨<br>
        <strong>TOTAL TTC : ${document.getElementById('totalTTC').textContent}‚Ç¨</strong>
      </div>
      <div style="background:#e9ecef;padding:15px;font-size:14px;">
        <strong>Conditions :</strong> NFC 15-100 | Paiement 30 jours | Valable 30 jours
      </div>
    </body></html>`);
  win.document.close();
  win.print();
}

function viderPanier() {
  if (confirm('Vider le panier ?')) {
    panier = [];
    localStorage.removeItem('panierMELEC');
    mettreAJourTableau();
  }
}
</script>

</body>
</html>
